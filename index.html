<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rive â€¢ Leaderboard</title>
  <style>
    html, body { height: 100%; }
    body { font-family: sans-serif; margin: 0; padding: 0; background: #FFF; }
    #rive-canvas { position: absolute; inset: 0; width: 100%; height: 100%; display: block; background: #FFF; }
  </style>
</head>
<body>
  <canvas id="rive-canvas"></canvas>

  <script src="https://unpkg.com/@rive-app/webgl2@2" crossorigin="anonymous"></script>
  <script>
  /* ======================================================================= */
  /*  1) CONFIG / OKTA + FALLBACK (user_login_id)                            */
  /* ======================================================================= */

  const PUBLISHED_CSV_WHOLE_DOC =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vTPvCfe-DO63KzdF7tixoFLCFY13ufNSsMEr89LF11rcATicR_tK7PZK-r7HAV4D4_iajXRQG_vBu23/pub?output=csv";

  const PUB_HTML_URL = PUBLISHED_CSV_WHOLE_DOC.replace(/\/pub\?output=csv.*/i, "/pubhtml");
  const BASE_CSV_URL = PUBLISHED_CSV_WHOLE_DOC.replace(/\/pub\?output=csv.*/i, "/pub?single=true&output=csv");

  const OKTA_STUDENT_NAME    = window.firstName  || "";
  const OKTA_STUDENT_SURNAME = window.lastName   || "";
  const OKTA_STUDENT_EMAIL   = (window.email || "").toLowerCase();
  const OKTA_FULL_NAME       = `${OKTA_STUDENT_NAME} ${OKTA_STUDENT_SURNAME}`.trim();

  const SIMULATED_USER_LOGIN_ID = "teneotest@teneoeducation.com"; // for local testing

  const HERO_SLOTS = 3;
  const TABLE_SLOTS = 7;
  const TABLE_START_SLOT = HERO_SLOTS + 1;

  const layout = new rive.Layout({ fit: rive.Fit.Layout, layoutScaleFactor: 1 });

  const canvas = document.getElementById('rive-canvas');
  let r = null, vm1 = null, studentVM = null, overviewVM = null;

  const datasets = {
    points:     { rows: [], pages: 1, map: new Map() },
    attendance: { rows: [], pages: 1, map: new Map() },
    homework:   { rows: [], pages: 1, map: new Map() },
  };
  let active = 'points';
  let pageIndex = 0;

  /* ======================================================================= */
  /*  2) UTILS                                                               */
  /* ======================================================================= */

  function resize() { try { r?.resizeDrawingSurfaceToCanvas(); } catch {} }
  addEventListener('resize', resize);

  function parseCSV(text) {
    const rows = [];
    let row = [], field = "", inQuotes = false;
    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      if (inQuotes) {
        if (c === '"') {
          if (text[i + 1] === '"') { field += '"'; i++; } else { inQuotes = false; }
        } else field += c;
      } else {
        if (c === '"') inQuotes = true;
        else if (c === ',') { row.push(field); field = ""; }
        else if (c === '\n') { row.push(field); rows.push(row); row = []; field = ""; }
        else if (c === '\r') { /* ignore */ }
        else field += c;
      }
    }
    row.push(field); rows.push(row);
    return rows;
  }

  // normalize header matching (handle dots, spaces, case)
  function idxAny(headers, patterns) {
    const norm = s => String(s || '')
      .toLowerCase()
      .replace(/\./g, '')        // "No.of" -> "Noof"
      .replace(/\s+/g, ' ')
      .trim();
    const H = headers.map(h => norm(h));
    for (const p of patterns) {
      const target = norm(p);
      const i = H.indexOf(target);
      if (i !== -1) return i;
    }
    return -1;
  }

  function num(v) {
    if (v == null) return 0;
    const n = Number(String(v).replace(/[, ]+/g, ''));
    return isNaN(n) ? 0 : n;
  }

  function numLoose(v) {
    const m = String(v ?? '').match(/-?\d+(\.\d+)?/);
    return m ? Number(m[0]) : 0;
  }

  // === Points status helpers (Explorer | Hero | Icon | Legend)
function normalizePointsStatus(s) {
  const v = String(s || '').trim().toLowerCase();
  if (v.startsWith('explorer')) return 'Explorer';
  if (v.startsWith('hero'))     return 'Hero';
  if (v.startsWith('icon'))     return 'Icon';
  if (v.startsWith('legend'))   return 'Legend';
  return null;
}

function getPointsStatusForUser(userId) {
  const id = String(userId || '').toLowerCase();
  const i = datasets.points?.map?.get(id);
  const row = (i != null) ? datasets.points.rows[i] : null;
  return normalizePointsStatus(row?.status);
}


  function findGidForSheet(html, sheetName) {
    const esc = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const nameRe = esc(String(sheetName).trim());
    let m = new RegExp(`href="[^"]*?gid=(\\d+)[^"]*"[^>]*>\\s*${nameRe}\\s*<`, 'i').exec(html);
    if (m) return m[1];
    m = new RegExp(`data-gid="(\\d+)"[^>]*>\\s*${nameRe}\\s*<`, 'i').exec(html);
    if (m) return m[1];
    const near = new RegExp(`${nameRe}[\\s\\S]{0,200}?gid=(\\d+)`, 'i').exec(html);
    if (near) return near[1];
    return null;
  }

  function computeTotalPages(totalRows) {
    const remaining = Math.max(0, totalRows - HERO_SLOTS);
    return Math.max(1, Math.ceil(remaining / TABLE_SLOTS));
  }

  async function fetchCsvOrThrow(url) {
    const res = await fetch(url, { credentials: "omit" });
    if (res.redirected && /accounts\.google\.com/i.test(res.url)) {
      throw new Error(
        "[Sheets] Redirected to Google login. Ensure the sheet is Published to the web (Entire document) and visible to anyone."
      );
    }
    if (!res.ok) throw new Error(`[Sheets] HTTP ${res.status} while fetching ${url}`);
    return res.text();
  }

  function getPreferredUserId() {
    return (OKTA_STUDENT_EMAIL || SIMULATED_USER_LOGIN_ID || "").toLowerCase();
  }

  function pickRowByUserStrict(ds, userId) {
    if (!ds || !userId) return null;
    if (ds.map && ds.map.has(userId)) {
      return ds.rows[ds.map.get(userId)];
    }
    return null;
  }

  function synthesizeUserRow(userId) {
    const fromPoints = pickRowByUserStrict(datasets.points, userId);
    const name   = fromPoints?.name || (OKTA_FULL_NAME || "Student");

    return {
      i: -1,
      position: 0,
      userId: userId,
      email: userId,
      name,
      lessonAttendance: 0,
      moduleCompletion: 0,
      assessmentSubmission: 0,
      homework: 0,
      score: 0,
      change: 0,
      attendanceLevel: 0,
      attendanceDay: 0,
      homeworkLevel: 0,
      homeworkDay: 0,
      status: ''
    };
  }

  /* ======================================================================= */
  /*  3) PARSERS (ALIGNED TO YOUR HEADERS)                                   */
  /* ======================================================================= */

  // POINTS
  // canvas_user_id, user_login_id, dcid, student_number, curriculum, phase, Email Address,
  // grade, Student Name, Current Position, Last Week Position,
  // Change (from last week to this week), Lesson Attendance, Assessment Submission,
  // Module Completion, Current Total Points, Last Weeks Total Points, Points Change,
  // Ranking %, Status, homework_completion, Rewards Percentage, Rewards Earned
  function parsePoints(csvText) {
    const rows = parseCSV(csvText).filter(r => r.length && r.some(c => (c || '').trim() !== ''));
    if (!rows.length) return [];
    const headersRaw = rows[0].map(h => (h || '').trim());

    const idI        = idxAny(headersRaw, ['user_login_id']);
    const nameI      = idxAny(headersRaw, ['Student Name']);

    const curPosI    = idxAny(headersRaw, ['Current Position']);
    const lastPosI   = idxAny(headersRaw, ['Last Week Position']);
    const changeI    = idxAny(headersRaw, ['Change (from last week to this week)']);

    const lessonI    = idxAny(headersRaw, ['Lesson Attendance']);
    const assessI    = idxAny(headersRaw, ['Assessment Submission']);
    const moduleI    = idxAny(headersRaw, ['Module Completion']);
    const curTotalI  = idxAny(headersRaw, ['Current Total Points']);
    const lastTotalI = idxAny(headersRaw, ['Last Weeks Total Points']);
    const ptsChangeI = idxAny(headersRaw, ['Points Change']);
    const rankPctI   = idxAny(headersRaw, ['Ranking %']);
    const statusI    = idxAny(headersRaw, ['Status']);
    const hwCompI    = idxAny(headersRaw, ['homework_completion']);

    const out = rows.slice(1).map((r,i) => {
      const userId = String(r[idI] || '').trim().toLowerCase();
      if (!userId) return null;
      const name   = String(r[nameI] || '').trim();

      const lesson = lessonI    !== -1 ? numLoose(r[lessonI])    : 0;
      const assess = assessI    !== -1 ? numLoose(r[assessI])    : 0;
      const module = moduleI    !== -1 ? numLoose(r[moduleI])    : 0;
      const hwcomp = hwCompI    !== -1 ? numLoose(r[hwCompI])    : 0;

      // score from "Current Total Points"
      const score  = curTotalI  !== -1 ? num(r[curTotalI])       : 0;

      // change from "Change (from last week to this week)" if present
      const change = changeI    !== -1 ? numLoose(r[changeI])    : 0;

      const position = curPosI  !== -1 ? numLoose(r[curPosI])    : undefined;

      return {
        i,
        userId,
        email: userId,
        name,
        firstName: name,
        surname: '',
        lessonAttendance:     lesson,
        assessmentSubmission: assess,
        moduleCompletion:     module,
        homework:             hwcomp,
        score,
        change,
        position,
        status: String((statusI !== -1 ? r[statusI] : '') || '').trim()
      };
    }).filter(Boolean);

    return out;
  }

  // ATTENDANCE & HOMEWORK STREAKS
  // canvas_user_id, user_login_id, dcid, student_number, curriculum, phase,
  // grade, Student Name, No.of streak days, Level, Status, Position
  function parseStreaks(csvText, kind /* 'attendance' | 'homework' */) {
    const rows = parseCSV(csvText).filter(r => r.length && r.some(c => (c || '').trim() !== ''));
    if (!rows.length) return [];
    const headersRaw = rows[0].map(h => (h || '').trim());

    const idI     = idxAny(headersRaw, ['user_login_id']);
    const nameI   = idxAny(headersRaw, ['Student Name']);
    const daysI   = idxAny(headersRaw, ['No.of streak days','No. of Streak Days','No of Streak Days']);
    const levelI  = idxAny(headersRaw, ['Level']);
    const statusI = idxAny(headersRaw, ['Status']);
    const posI    = idxAny(headersRaw, ['Position']);

    const out = rows.slice(1).map((r,i) => {
      const userId = String(r[idI] || '').trim().toLowerCase();
      if (!userId) return null;
      const name   = String(r[nameI] || '').trim();

      const level  = levelI !== -1 ? numLoose(r[levelI]) : 0;
      const days   =  daysI !== -1 ? numLoose(r[daysI])  : 0;
      const pos    =   posI !== -1 ? numLoose(r[posI])   : undefined;
      const status = String((statusI !== -1 ? r[statusI] : '') || '').trim();

      const row = {
        i,
        userId,
        email: userId,
        name,
        score: 0,
        change: 0,
        status,
        position: pos
      };

      if (kind === 'attendance') {
        row.attendanceLevel = level;
        row.attendanceDay   = days;
      } else {
        row.homeworkLevel   = level;
        row.homeworkDay     = days;
      }
      return row;
    }).filter(Boolean);

    return out;
  }

  /* ======================================================================= */
  /*  4) DATA LOADING                                                         */
  /* ======================================================================= */

  async function preloadAllThree() {
    const html = await fetch(PUB_HTML_URL, { credentials: "omit" }).then(r => r.text());

    const gidPoints     = findGidForSheet(html, 'Points')             ?? 0;
    const gidAttendance = findGidForSheet(html, 'Attendance Streaks') ?? 0;
    const gidHomework   = findGidForSheet(html, 'Homework Streaks')   ?? 0;

    const [csvPoints, csvAttend, csvHome] = await Promise.all([
      fetchCsvOrThrow(`${BASE_CSV_URL}&gid=${gidPoints}`),
      fetchCsvOrThrow(`${BASE_CSV_URL}&gid=${gidAttendance}`),
      fetchCsvOrThrow(`${BASE_CSV_URL}&gid=${gidHomework}`)
    ]);

    datasets.points.rows     = parsePoints(csvPoints);
    datasets.attendance.rows = parseStreaks(csvAttend, 'attendance');
    datasets.homework.rows   = parseStreaks(csvHome,   'homework');

    // Sort & index
    for (const key of Object.keys(datasets)) {
      const ds = datasets[key];

      if (key === 'points') {
        // Highest total points first; if equal, keep CSV order
        ds.rows.sort((a,b) => ((b.score ?? 0) - (a.score ?? 0)) || (a.i - b.i));
      } else if (key === 'attendance') {
        ds.rows.sort((a,b) =>
          ((b.attendanceLevel ?? 0) - (a.attendanceLevel ?? 0)) ||
          ((b.attendanceDay   ?? 0) - (a.attendanceDay   ?? 0)) ||
          (a.i - b.i)
        );
      } else if (key === 'homework') {
        ds.rows.sort((a,b) =>
          ((b.homeworkLevel ?? 0) - (a.homeworkLevel ?? 0)) ||
          ((b.homeworkDay   ?? 0) - (a.homeworkDay   ?? 0)) ||
          (a.i - b.i)
        );
      }

      for (let i = 0; i < ds.rows.length; i++) ds.rows[i].position = i + 1;
      ds.pages = computeTotalPages(ds.rows.length);
      ds.map   = new Map(ds.rows.map((row, i) => [row.userId, i]));
    }
  }

  /* ======================================================================= */
  /*  5) RIVE BOOTSTRAP                                                       */
  /* ======================================================================= */

  r = new rive.Rive({
    src: 'leaderboard.riv',
    canvas,
    artboard: 'Dashboard',
    stateMachines: ['State Machine 1'],
    autoplay: true,
    layout,
    autoBind: true,
    onLoad: async () => {
      resize();

      vm1 =
        (typeof r.viewModelInstance === 'function' ? r.viewModelInstance('View Model 1') : null) ||
        r.viewModelInstance ||
        r.contents?.viewModel?.('View Model 1')?.instance?.();

      overviewVM =
        (typeof r.viewModelInstance === 'function' ? r.viewModelInstance('Overview') : null) ||
        vm1?.viewModel?.('Overview') || vm1?.getViewModel?.('Overview') ||
        r.contents?.viewModel?.('Overview')?.instance?.();

      studentVM = resolveStudentVM(r, vm1);

      if (!vm1) return;

      setLoaded(false);

      r.on?.(rive.EventType.RiveEvent, (evt) => {
        const ev = evt?.data;
        if (!ev || ev.type !== rive.RiveEventType.General) return;
        if (ev.name === 'PageForward') { goPage(+1); return; }
        if (ev.name === 'PageBack')    { goPage(-1); return; }
      });

      try {
        await preloadAllThree();
      } catch (err) {
        console.error(err?.message || err);
        setLoaded(false);
        try {
          const errStr = vm1?.string?.('ErrorMessage') || vm1?.getString?.('ErrorMessage');
          if (errStr) errStr.value = String(err?.message || 'Failed to load data.');
        } catch {}
        return;
      }

      writeOverview();

      const mode0 = readModeFromBooleans(true);
      setMode(mode0, { resetPage: true });

      setLoaded(true);
      console.log("[READY] Leaderboard loaded");

      // Poll for Rive-initiated boolean flips
      let lastMode = mode0;
      setInterval(() => {
        const m = readModeFromBooleans(false);
        if (m !== lastMode) {
          lastMode = m;
          setMode(m, { resetPage: true });
        }
      }, 300);
    }
  });

  function resolveStudentVM(r, vm1) {
    const candidates = [];
    try { const v = vm1?.viewModel?.('Student') || vm1?.getViewModel?.('Student'); if (v) candidates.push(['vm1->Student', v]); } catch {}
    try { const v = (typeof r.viewModelInstance === 'function' ? r.viewModelInstance('Student') : r.viewModelInstance); if (v) candidates.push(['r.viewModelInstance(Student)', v]); } catch {}
    try { const v = r.contents?.viewModel?.('Student')?.instance?.(); if (v) candidates.push(['contents->Student.instance()', v]); } catch {}
    try { const ui = vm1?.viewModel?.('UserInfo') || vm1?.getViewModel?.('UserInfo'); const v = ui?.viewModel?.('Student') || ui?.getViewModel?.('Student'); if (v) candidates.push(['vm1->UserInfo->Student', v]); } catch {}
    const hit = candidates.find(([_, inst]) => !!inst) || null;
    return hit ? hit[1] : null;
  }

  /* ======================================================================= */
  /*  6) MODE / PAGINATION / OVERVIEW                                         */
  /* ======================================================================= */

  function readModeFromBooleans(verbose=false) {
    const getB = (k) => {
      const b = (vm1?.boolean?.(k) ?? vm1?.getBoolean?.(k));
      return b && 'value' in b ? !!b.value : false;
    };
    const p = getB('isPoints');
    const a = getB('isAttendance');
    const h = getB('isHomework');
    const mode = p ? 'points' : a ? 'attendance' : h ? 'homework' : 'points';
    if (verbose) console.log('[MODE] flags â†’', {isPoints:p, isAttendance:a, isHomework:h, mode});
    return mode;
  }

  function setStudentPointsVsStreaks(isPointsMode) {
    const tries = [];
    tries.push(studentVM);
    tries.push((typeof r.viewModelInstance === 'function' ? r.viewModelInstance('Student') : r.viewModelInstance) || null);
    tries.push(r.contents?.viewModel?.('Student')?.instance?.() || null);
    const ui = vm1?.viewModel?.('UserInfo') || vm1?.getViewModel?.('UserInfo');
    tries.push(ui?.viewModel?.('Student') || ui?.getViewModel?.('Student') || null);
    const uniq = [...new Set(tries.filter(Boolean))];
    for (const inst of uniq) {
      const prop = inst?.boolean?.('PointsvsStreaks') ?? inst?.getBoolean?.('PointsvsStreaks');
      if (prop && 'value' in prop) prop.value = !!isPointsMode;
    }
  }

  function setMode(which, { resetPage }) {
    active = which;

    // Points â†’ false, Streaks (attendance/homework) â†’ true
setStudentPointsVsStreaks(active !== 'points');


    const ds = datasets[active];
    if (!ds) { console.warn('[MODE] unknown dataset', which); return; }

    ds.pages = computeTotalPages(ds.rows.length);
    pageIndex = resetPage ? 0 : Math.min(pageIndex, ds.pages - 1);

    renderHero(ds.rows);

    const preferUserId = getPreferredUserId();
    let rowForPanels = pickRowByUserStrict(ds, preferUserId);
    if (!rowForPanels) rowForPanels = synthesizeUserRow(preferUserId);
    writeStudentEverywhere(rowForPanels);

    writePageNumbers(ds.pages);
    renderTable(ds.rows);
    firePlay();
  }

  function goPage(delta) {
    const ds = datasets[active];
    const next = Math.min(Math.max(pageIndex + delta, 0), ds.pages - 1);
    if (next === pageIndex) return;
    pageIndex = next;
    writePageNumbers(ds.pages);
    renderTable(ds.rows);
    firePlay();
  }

  function writePageNumbers(totalPages) {
    const pi = vm1?.number?.('PageIndex')  ?? vm1?.getNumber?.('PageIndex');
    const tp = vm1?.number?.('TotalPages') ?? vm1?.getNumber?.('TotalPages');
    if (pi) pi.value = pageIndex + 1;
    if (tp) tp.value = totalPages;
  }

  function writeOverview() {
    if (!overviewVM) return;

    const preferUserId = getPreferredUserId();

    // Set Overview enum from Points sheet "Status"
const ps1 = overviewVM.enum?.('PointsStatusEnum1') ?? overviewVM.getEnum?.('PointsStatusEnum1');
if (ps1) { try { ps1.value = getPointsStatusForUser(preferUserId) ?? null; } catch {} }
console.log('[Overview Enum]', preferUserId, 'â†’', getPointsStatusForUser(preferUserId));

    let p = pickRowByUserStrict(datasets.points,     preferUserId);
    let a = pickRowByUserStrict(datasets.attendance, preferUserId);
    let h = pickRowByUserStrict(datasets.homework,   preferUserId);

    if (!p) p = synthesizeUserRow(preferUserId);
    if (!a) a = synthesizeUserRow(preferUserId);
    if (!h) h = synthesizeUserRow(preferUserId);

    const v = {
      StudentName:          overviewVM.string?.('StudentName')         ?? overviewVM.getString?.('StudentName'),
      StudentFirstName:     overviewVM.string?.('StudentFirstName')    ?? overviewVM.getString?.('StudentFirstName'),
      AttendanceLevel:      overviewVM.number?.('AttendanceLevel')     ?? overviewVM.getNumber?.('AttendanceLevel'),
      AttendanceStreak:     overviewVM.number?.('AttendanceStreak')    ?? overviewVM.getNumber?.('AttendanceStreak'),
      LessonAttendance:     overviewVM.number?.('LessonAttendance')    ?? overviewVM.getNumber?.('LessonAttendance'),
      ModuleCompletion:     overviewVM.number?.('ModuleCompletion')    ?? overviewVM.getNumber?.('ModuleCompletion'),
      Homework:             overviewVM.number?.('Homework')            ?? overviewVM.getNumber?.('Homework'),
      AssessmentSubmission: overviewVM.number?.('AssessmentSubmission') ?? overviewVM.getNumber?.('AssessmentSubmission'),
      TotalPoints:          overviewVM.number?.('TotalPoints')         ?? overviewVM.getNumber?.('TotalPoints'),
      HomeworkLevel:        overviewVM.number?.('HomeworkLevel')       ?? overviewVM.getNumber?.('HomeworkLevel'),
      HomeworkStreak:       overviewVM.number?.('HomeworkStreak')      ?? overviewVM.getNumber?.('HomeworkStreak'),
    };

    const name = p?.name || a?.name || h?.name || '';
    const first = (name || '').trim().split(/\s+/)[0] || '';
    if (v.StudentFirstName) v.StudentFirstName.value = first;

    if (v.StudentName)          v.StudentName.value          = name;
    if (v.TotalPoints)          v.TotalPoints.value          = p?.score ?? 0; // Current Total Points
    if (v.LessonAttendance)     v.LessonAttendance.value     = p?.lessonAttendance ?? 0;
    if (v.ModuleCompletion)     v.ModuleCompletion.value     = p?.moduleCompletion ?? 0;
    if (v.Homework)             v.Homework.value             = p?.homework ?? 0;
    if (v.AssessmentSubmission) v.AssessmentSubmission.value = p?.assessmentSubmission ?? 0;
    if (v.AttendanceLevel)      v.AttendanceLevel.value      = a?.attendanceLevel ?? 0;
    if (v.AttendanceStreak)     v.AttendanceStreak.value     = a?.attendanceDay   ?? 0;
    if (v.HomeworkLevel)        v.HomeworkLevel.value        = h?.homeworkLevel   ?? 0;
    if (v.HomeworkStreak)       v.HomeworkStreak.value       = h?.homeworkDay     ?? 0;
  }

  /* ======================================================================= */
  /*  7) RENDERING (rows + student panel)                                     */
  /* ======================================================================= */

  function setEntryVisible(entryVM, show) {
    const vis = entryVM?.boolean?.('Visible') ?? entryVM?.getBoolean?.('Visible');
    if (vis && 'value' in vis) vis.value = !!show;
  }

  function renderHero(rows) {
    for (let i = 0; i < HERO_SLOTS; i++) {
      const slotName = String(i + 1);
      const entryVM = vm1?.viewModel?.(slotName) || vm1?.getViewModel?.(slotName);
      const row = rows[i];
      if (!entryVM) continue;
      setEntryVisible(entryVM, !!row);
      writeEntry(entryVM, row, i + 1);
    }
  }

  function renderTable(rows) {
    const firstIdx = HERO_SLOTS + pageIndex * TABLE_SLOTS;
    const remaining = Math.max(0, rows.length - HERO_SLOTS - pageIndex * TABLE_SLOTS);
    const rowsThisPage = Math.min(TABLE_SLOTS, remaining);

    for (let j = 0; j < rowsThisPage; j++) {
      const slot = TABLE_START_SLOT + j;
      const entryVM = vm1?.viewModel?.(String(slot)) || vm1?.getViewModel?.(String(slot));
      if (!entryVM) continue;
      const row = rows[firstIdx + j];
      const fallbackPos = HERO_SLOTS + (pageIndex * TABLE_SLOTS) + j + 1;
      setEntryVisible(entryVM, true);
      writeEntry(entryVM, row, fallbackPos);
    }
    for (let j = rowsThisPage; j < TABLE_SLOTS; j++) {
      const slot = TABLE_START_SLOT + j;
      const entryVM = vm1?.viewModel?.(String(slot)) || vm1?.getViewModel?.(String(slot));
      if (!entryVM) continue;
      setEntryVisible(entryVM, false);
      writeEntry(entryVM, null, 0);
    }
  }

  function writeEntry(entryVM, row, fallbackPosition) {

    const ps3 = entryVM.enum?.('PointsStatusEnum3') ?? entryVM.getEnum?.('PointsStatusEnum3');
    const posProp     = entryVM.number?.('Position')             ?? entryVM.getNumber?.('Position');
    const nameProp    = entryVM.string?.('Name')                  ?? entryVM.getString?.('Name');
    const scoreProp   = entryVM.number?.('Score')                 ?? entryVM.getNumber?.('Score');
    const changeProp  = entryVM.number?.('ChangeState')           ?? entryVM.getNumber?.('ChangeState');
    const asProp      = entryVM.number?.('AssessmentSubmission')  ?? entryVM.getNumber?.('AssessmentSubmission');
    const hwProp      = entryVM.number?.('Homework')              ?? entryVM.getNumber?.('Homework');
    const mcProp      = entryVM.number?.('ModuleCompletion')      ?? entryVM.getNumber?.('ModuleCompletion');
    const laProp      = entryVM.number?.('LessonAttendance')      ?? entryVM.getNumber?.('LessonAttendance');
    const statusProp  = entryVM.string?.('Status')                ?? entryVM.getString?.('Status');
    const statusEnum  = entryVM.enum?.('StatusEnum')              ?? entryVM.getEnum?.('StatusEnum');

    if (row) {
      if (posProp)  posProp.value  = row.position ?? fallbackPosition ?? 0;
      if (nameProp) nameProp.value = row.name ?? '';
      if (ps3) {
  const val = getPointsStatusForUser(row?.userId); // always from Points sheet
  try { ps3.value = val ?? null; } catch {}
  console.log('[Entry Enum]', row?.name, 'â†’', getPointsStatusForUser(row?.userId));

}


      if (active === 'points') {
        if (laProp) laProp.value = row.lessonAttendance ?? 0;
        if (mcProp) mcProp.value = row.moduleCompletion ?? 0;
        if (hwProp) hwProp.value = row.homework ?? 0;
        if (asProp) asProp.value = row.assessmentSubmission ?? 0;
        if (scoreProp)  scoreProp.value  = row.score ?? 0;          // from Current Total Points
        if (changeProp) changeProp.value = row.change ?? 0;
      } else if (active === 'attendance') {
        if (laProp) laProp.value = row.attendanceLevel ?? 0;
        if (mcProp) mcProp.value = row.attendanceDay   ?? 0;
        if (hwProp) hwProp.value = 0;
        if (asProp) asProp.value = 0;
        if (scoreProp)  scoreProp.value  = row.attendanceDay ?? 0;  // days shown as Score
        if (changeProp) changeProp.value = 0;
      } else if (active === 'homework') {
        if (hwProp) hwProp.value = row.homeworkLevel ?? 0;
        if (asProp) asProp.value = row.homeworkDay   ?? 0;
        if (laProp) laProp.value = 0;
        if (mcProp) mcProp.value = 0;
        if (scoreProp)  scoreProp.value  = row.homeworkDay ?? 0;    // days shown as Score
        if (changeProp) changeProp.value = 0;
      }

      // Always write the status text; set enum only for streak modes
      if (statusProp) statusProp.value = row.status || '';
      if (statusEnum && active !== 'points') {
        const v = (row.status || '').trim();
        if (v === 'On Track' || v === 'Streak Warning' || v === 'Level Reset') {
          try { statusEnum.value = v; } catch {}
        }
      } else if (statusEnum && active === 'points') {
  // NEW: when Points mode is active, set all StatusEnums to "Points"
  try { statusEnum.value = 'Points'; } catch {}
}


    } else {
      if (ps3) { try { ps3.value = null; } catch {} }
      if (posProp)    posProp.value    = fallbackPosition || 0;
      if (nameProp)   nameProp.value   = '';
      if (scoreProp)  scoreProp.value  = 0;
      if (changeProp) changeProp.value = 0;
      if (laProp)     laProp.value     = 0;
      if (mcProp)     mcProp.value     = 0;
      if (hwProp)     hwProp.value     = 0;
      if (asProp)     asProp.value     = 0;
      if (statusProp) statusProp.value = '';
    }
  }

  function writeStudentEverywhere(row) {
    const tries = [];
    tries.push(studentVM);
    tries.push((typeof r.viewModelInstance === 'function' ? r.viewModelInstance('Student') : r.viewModelInstance) || null);
    tries.push(r.contents?.viewModel?.('Student')?.instance?.() || null);
    const ui = vm1?.viewModel?.('UserInfo') || vm1?.getViewModel?.('UserInfo');
    tries.push(ui?.viewModel?.('Student') || ui?.getViewModel?.('Student') || null);
    const uniq = [...new Set(tries.filter(Boolean))];
    for (const inst of uniq) writeStudent(inst, row);
  }

  // Student panel mirrors per-mode values (and status)
  function writeStudent(svm, row) {
    const ps2 = svm?.enum?.('PointsStatusEnum2') ?? svm?.getEnum?.('PointsStatusEnum2');
    const sName  = svm?.string?.('StudentName')     ?? svm?.getString?.('StudentName');
    const sPos   = svm?.number?.('StudentPosition') ?? svm?.getNumber?.('StudentPosition');
    const sScore = svm?.number?.('StudentScore')    ?? svm?.getNumber?.('StudentScore');
    const sChg   = svm?.number?.('StudentChange')   ?? svm?.getNumber?.('StudentChange');

    const sStatus = svm?.string?.('Status') ?? svm?.getString?.('Status');
    const sStatusEnum = svm?.enum?.('StatusEnum') ?? svm?.getEnum?.('StatusEnum');

    if (!row) {
      if (ps2) { try { ps2.value = null; } catch {} }
      if (sName)  sName.value  = '';
      if (sPos)   sPos.value   = 0;
      if (sScore) sScore.value = 0;
      if (sChg)   sChg.value   = 0;
      if (sStatus) sStatus.value = '';
      return;
    }

    if (sName) sName.value = row.name ?? '';
    if (sPos)  sPos.value  = row.position ?? 0;
    if (ps2) { try { ps2.value = getPointsStatusForUser(row?.userId) ?? null; } catch {} }
    console.log('[Student Enum]', row?.name, 'â†’', getPointsStatusForUser(row?.userId));



    if (active === 'points') {
      if (sScore) sScore.value = row.score ?? 0;      // Current Total Points
      if (sChg)   sChg.value   = row.change ?? 0;
    } else if (active === 'attendance') {
      if (sScore) sScore.value = row.attendanceLevel ?? 0;
      if (sChg)   sChg.value   = row.attendanceDay   ?? 0;
    } else if (active === 'homework') {
      if (sScore) sScore.value = row.homeworkLevel ?? 0;
      if (sChg)   sChg.value   = row.homeworkDay   ?? 0;
    }

    // mirror status into Student panel; enum only in streak modes
    const sv = (row.status || '').trim();
    if (sStatus) sStatus.value = sv;
    if (sStatusEnum && active !== 'points') {
      if (sv === 'On Track' || sv === 'Streak Warning' || sv === 'Level Reset') {
        try { sStatusEnum.value = sv; } catch {}
      }
    } else if (sStatusEnum && active === 'points') {
      // Optional: clear enum in points mode.
      try { sStatusEnum.value = null; } catch {}
    }

    // Prefer Okta name if this is the logged-in viewer
    if (row.email && row.email === OKTA_STUDENT_EMAIL && OKTA_FULL_NAME && sName) {
      sName.value = OKTA_FULL_NAME;
    }
  }

  /* ======================================================================= */
  /*  8) RIVE BRIDGES                                                         */
  /* ======================================================================= */

  function firePlay() {
    const play = vm1?.trigger?.('Play') || vm1?.getTrigger?.('Play');
    if (play?.trigger) play.trigger();
    else if (play?.fire) play.fire();
  }

  function setLoaded(flag) {
    const b = vm1?.boolean?.('isLoaded') ?? vm1?.getBoolean?.('isLoaded');
    if (b && 'value' in b) b.value = !!flag;
  }
  </script>
</body>
</html>
