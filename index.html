<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rive • Leaderboard</title>
  <style>
    html, body { height: 100%; }
    body { font-family: sans-serif; margin: 0; padding: 0; background: #FFF; }
    #rive-canvas { position: absolute; inset: 0; width: 100%; height: 100%; display: block; background: #FFF; }
  </style>
</head>
<body>
  <canvas id="rive-canvas"></canvas>

  <script src="https://unpkg.com/@rive-app/webgl2@2" crossorigin="anonymous"></script>
<script>
  // ---------- Config ----------
  const PUB_HTML_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXaiZRd6sKMSLZUV0n9N6Cb4XOCFtS2ZUW2IxSKsciht8VPYBQ2ViuQVZJWXjm56IYGjKJrxZs8rt0/pubhtml";
  const DEFAULT_USER_ID = "qwe712"; // override via ?userId=...

  const HERO_SLOTS = 3;
  const TABLE_SLOTS = 7;
  const TABLE_START_SLOT = HERO_SLOTS + 1; // slot "4"

  const layout = new rive.Layout({ fit: rive.Fit.Layout, layoutScaleFactor: 1 });
  const canvas = document.getElementById('rive-canvas');
  let r = null, vm1 = null, studentVM = null, overviewVM = null;

  const datasets = {
    points:     { rows: [], pages: 1, map: new Map() },
    attendance: { rows: [], pages: 1, map: new Map() },
    homework:   { rows: [], pages: 1, map: new Map() },
  };
  let active = 'points';
  let pageIndex = 0;
  let dataReady = false;

  function resize() { try { r?.resizeDrawingSurfaceToCanvas(); } catch {} }
  addEventListener('resize', resize);

  r = new rive.Rive({
    src: 'leaderboard.riv',
    canvas,
    artboard: 'Dashboard',
    stateMachines: ['State Machine 1'],
    autoplay: true,
    layout,
    autoBind: true,
    onLoad: async () => {
      console.log('[LOAD] Rive onLoad');

      resize();
      vm1 =
        (typeof r.viewModelInstance === 'function' ? r.viewModelInstance('View Model 1') : null) ||
        r.viewModelInstance ||
        r.contents?.viewModel?.('View Model 1')?.instance?.();

      studentVM =
        (typeof r.viewModelInstance === 'function' ? r.viewModelInstance('Student') : null) ||
        vm1?.viewModel?.('Student') || vm1?.getViewModel?.('Student') ||
        r.contents?.viewModel?.('Student')?.instance?.();

      overviewVM =
        (typeof r.viewModelInstance === 'function' ? r.viewModelInstance('Overview') : null) ||
        vm1?.viewModel?.('Overview') || vm1?.getViewModel?.('Overview') ||
        r.contents?.viewModel?.('Overview')?.instance?.();

      console.log('[VM] vm1?', !!vm1, '| Student?', !!studentVM, '| Overview?', !!overviewVM);
      if (!vm1) return;

      setLoaded(false);

      r.on?.(rive.EventType.RiveEvent, (evt) => {
        const ev = evt?.data;
        if (!ev || ev.type !== rive.RiveEventType.General) return;
        console.log('[EVENT]', ev.name);
        if (ev.name === 'PageForward') { goPage(+1); return; }
        if (ev.name === 'PageBack')    { goPage(-1); return; }
      });

      await preloadAllThree();
      dataReady = true;

      const userId = getCurrentUserId();
      console.log('[USER] id:', userId);

      writeOverview(userId);

      const mode0 = readModeFromBooleans(true);
      setMode(mode0, { resetPage: true });

      setLoaded(true);

      let lastMode = mode0;
      setInterval(() => {
        const m = readModeFromBooleans(false);
        if (m !== lastMode) {
          console.log('[MODE] boolean change →', m);
          lastMode = m;
          setMode(m, { resetPage: true });
        }
      }, 300);
    }
  });

  async function preloadAllThree() {
    console.log('[CSV] fetch pubhtml …');
    const html = await fetch(PUB_HTML_URL).then(r => r.text());
    const gidPoints     = findGidForSheet(html, 'Points')             ?? 0;
    const gidAttendance = findGidForSheet(html, 'Attendance Streaks') ?? 0;
    const gidHomework   = findGidForSheet(html, 'Homework Streaks')   ?? 0;
    console.log('[CSV] gids:', {gidPoints, gidAttendance, gidHomework});

    const baseCsv = PUB_HTML_URL.replace(/\/pubhtml(\?.*)?$/, "/pub?single=true&output=csv");
    const urlPoints     = `${baseCsv}&gid=${gidPoints}`;
    const urlAttendance = `${baseCsv}&gid=${gidAttendance}`;
    const urlHomework   = `${baseCsv}&gid=${gidHomework}`;
    console.log('[CSV] urls:', {urlPoints, urlAttendance, urlHomework});

    const [resP, resA, resH] = await Promise.all([fetch(urlPoints), fetch(urlAttendance), fetch(urlHomework)]);
    console.log('[CSV] status:', resP.status, resA.status, resH.status);

    const [csvPoints, csvAttend, csvHome] = await Promise.all([resP.text(), resA.text(), resH.text()]);

    datasets.points.rows     = parsePoints(csvPoints);
    datasets.attendance.rows = parseAttendance(csvAttend);
    datasets.homework.rows   = parseHomework(csvHome);

    for (const key of Object.keys(datasets)) {
      const ds = datasets[key];
      ds.rows.sort((a,b) => ((b.score ?? 0) - (a.score ?? 0)) || (a.i - b.i));
      for (let i = 0; i < ds.rows.length; i++) ds.rows[i].position = i + 1;
      ds.pages = computeTotalPages(ds.rows.length);
      ds.map = new Map(ds.rows.map((row, i) => [row.userId, i]));
      console.log(`[DATA] ${key}: rows=${ds.rows.length} pages=${ds.pages} sample0-2:`, ds.rows.slice(0,3));
    }
  }

  function findGidForSheet(html, sheetName) {
    const esc = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const nameRe = esc(String(sheetName).trim());
    let m = new RegExp(`href="[^"]*?gid=(\\d+)[^"]*"[^>]*>\\s*${nameRe}\\s*<`, 'i').exec(html);
    if (m) return m[1];
    m = new RegExp(`data-gid="(\\d+)"[^>]*>\\s*${nameRe}\\s*<`, 'i').exec(html);
    if (m) return m[1];
    const near = new RegExp(`${nameRe}[\\s\\S]{0,200}?gid=(\\d+)`, 'i').exec(html);
    if (near) return near[1];
    return null;
  }

  function writeOverview(userId) {
    if (!overviewVM) { console.warn('[OVERVIEW] VM missing'); return; }

    const pIdx = datasets.points.map.get(userId);
    const aIdx = datasets.attendance.map.get(userId);
    const hIdx = datasets.homework.map.get(userId);
    const p = typeof pIdx === 'number' ? datasets.points.rows[pIdx] : null;
    const a = typeof aIdx === 'number' ? datasets.attendance.rows[aIdx] : null;
    const h = typeof hIdx === 'number' ? datasets.homework.rows[hIdx] : null;

    console.log('[OVERVIEW] pIdx/aIdx/hIdx:', pIdx, aIdx, hIdx, '| rows:', {p, a, h});

    const v = {
      StudentName:          overviewVM.string?.('StudentName')       ?? overviewVM.getString?.('StudentName'),
      AttendanceLevel:      overviewVM.number?.('AttendanceLevel')   ?? overviewVM.getNumber?.('AttendanceLevel'),
      AttendanceStreak:     overviewVM.number?.('AttendanceStreak')  ?? overviewVM.getNumber?.('AttendanceStreak'),
      LessonAttendance:     overviewVM.number?.('LessonAttendance')  ?? overviewVM.getNumber?.('LessonAttendance'),
      ModuleCompletion:     overviewVM.number?.('ModuleCompletion')  ?? overviewVM.getNumber?.('ModuleCompletion'),
      Homework:             overviewVM.number?.('Homework')          ?? overviewVM.getNumber?.('Homework'),
      AssessmentSubmission: overviewVM.number?.('AssessmentSubmission') ?? overviewVM.getNumber?.('AssessmentSubmission'),
      TotalPoints:          overviewVM.number?.('TotalPoints')       ?? overviewVM.getNumber?.('TotalPoints'),
      HomeworkLevel:        overviewVM.number?.('HomeworkLevel')     ?? overviewVM.getNumber?.('HomeworkLevel'),
      HomeworkStreak:       overviewVM.number?.('HomeworkStreak')    ?? overviewVM.getNumber?.('HomeworkStreak'),
    };

    const name = p?.name || a?.name || h?.name || '';
    if (v.StudentName)          v.StudentName.value          = name;
    if (v.TotalPoints)          v.TotalPoints.value          = p?.score ?? 0;
    if (v.LessonAttendance)     v.LessonAttendance.value     = p?.lessonAttendance ?? 0;
    if (v.ModuleCompletion)     v.ModuleCompletion.value     = p?.moduleCompletion ?? 0;
    if (v.Homework)             v.Homework.value             = p?.homework ?? 0;
    if (v.AssessmentSubmission) v.AssessmentSubmission.value = p?.assessmentSubmission ?? 0;
    if (v.AttendanceLevel)      v.AttendanceLevel.value      = a?.attendanceLevel ?? 0;
    if (v.AttendanceStreak)     v.AttendanceStreak.value     = a?.attendanceDay   ?? 0;
    if (v.HomeworkLevel)        v.HomeworkLevel.value        = h?.homeworkLevel   ?? 0;
    if (v.HomeworkStreak)       v.HomeworkStreak.value       = h?.homeworkDay     ?? 0;
  }

  function readModeFromBooleans(verbose=false) {
    const getB = (k) => {
      const b = (vm1?.boolean?.(k) ?? vm1?.getBoolean?.(k));
      return b && 'value' in b ? !!b.value : false;
    };
    const p = getB('isPoints');
    const a = getB('isAttendance');
    const h = getB('isHomework');
    const mode = p ? 'points' : a ? 'attendance' : h ? 'homework' : 'points';
    if (verbose) console.log('[MODE] flags →', {isPoints:p, isAttendance:a, isHomework:h, mode});
    return mode;
  }

  function setMode(which, { resetPage }) {
    active = which;
    const ds = datasets[active];
    if (!ds) { console.warn('[MODE] unknown dataset', which); return; }

    ds.pages = computeTotalPages(ds.rows.length);
    pageIndex = resetPage ? 0 : Math.min(pageIndex, ds.pages - 1);

    console.log('[MODE] setMode:', which, '| rows:', ds.rows.length, '| pages:', ds.pages, '| pageIndex:', pageIndex);

    renderHero(ds.rows);
    const userId = getCurrentUserId();
    const uIdx = ds.map.get(userId);
    console.log('[STUDENT] userId:', userId, '| idx:', uIdx);
    if (studentVM) writeStudent(studentVM, (typeof uIdx === 'number') ? ds.rows[uIdx] : null);

    writePageNumbers(ds.pages);
    renderTable(ds.rows);
    firePlay();
  }

  function computeTotalPages(totalRows) {
    const remaining = Math.max(0, totalRows - HERO_SLOTS);
    return Math.max(1, Math.ceil(remaining / TABLE_SLOTS));
  }

  function goPage(delta) {
    const ds = datasets[active];
    const next = Math.min(Math.max(pageIndex + delta, 0), ds.pages - 1);
    if (next === pageIndex) return;
    pageIndex = next;
    writePageNumbers(ds.pages);
    renderTable(ds.rows);
    firePlay();
  }

  function writePageNumbers(totalPages) {
    const pi = vm1?.number?.('PageIndex')  ?? vm1?.getNumber?.('PageIndex');
    const tp = vm1?.number?.('TotalPages') ?? vm1?.getNumber?.('TotalPages');
    if (pi) pi.value = pageIndex + 1;
    if (tp) tp.value = totalPages;
  }

  function renderHero(rows) {
    for (let i = 0; i < HERO_SLOTS; i++) {
      const slotName = String(i + 1);
      const entryVM = vm1?.viewModel?.(slotName) || vm1?.getViewModel?.(slotName);
      const row = rows[i];
      console.log(`[HERO] slot ${slotName} → VM?`, !!entryVM, '| row?', !!row, row);
      if (!entryVM) continue;
      writeEntry(entryVM, row, i + 1);
    }
  }

  function renderTable(rows) {
    const firstIdx = HERO_SLOTS + pageIndex * TABLE_SLOTS;
    console.log('[TABLE] firstIdx:', firstIdx, '| pageIndex:', pageIndex);
    for (let j = 0; j < TABLE_SLOTS; j++) {
      const slot = TABLE_START_SLOT + j; // 4..10
      const slotName = String(slot);
      const entryVM = vm1?.viewModel?.(slotName) || vm1?.getViewModel?.(slotName);
      const row = rows[firstIdx + j];
      const fallbackPos = HERO_SLOTS + (pageIndex * TABLE_SLOTS) + j + 1;
      console.log(`[ROW] slot ${slotName} → VM?`, !!entryVM, '| row?', !!row, row);
      if (!entryVM) continue;
      writeEntry(entryVM, row, fallbackPos);
    }
  }

  function writeEntry(entryVM, row, fallbackPosition) {
    const posProp     = entryVM.number?.('Position')             ?? entryVM.getNumber?.('Position');
    const nameProp    = entryVM.string?.('Name')                  ?? entryVM.getString?.('Name');
    const scoreProp   = entryVM.number?.('Score')                 ?? entryVM.getNumber?.('Score');
    const changeProp  = entryVM.number?.('ChangeState')           ?? entryVM.getNumber?.('ChangeState');
    const asProp      = entryVM.number?.('AssessmentSubmission')  ?? entryVM.getNumber?.('AssessmentSubmission');
    const hwProp      = entryVM.number?.('Homework')              ?? entryVM.getNumber?.('Homework');
    const mcProp      = entryVM.number?.('ModuleCompletion')      ?? entryVM.getNumber?.('ModuleCompletion');
    const laProp      = entryVM.number?.('LessonAttendance')      ?? entryVM.getNumber?.('LessonAttendance');

    if (row) {
      console.log('[WRITE] entry', {pos: row.position, name: row.name, userId: row.userId, mode: active});
      if (posProp)  posProp.value  = row.position ?? fallbackPosition ?? 0;
      if (nameProp) nameProp.value = row.name ?? '';

      if (active === 'points') {
        if (laProp) laProp.value = row.lessonAttendance ?? 0;
        if (mcProp) mcProp.value = row.moduleCompletion ?? 0;
        if (hwProp) hwProp.value = row.homework ?? 0;
        if (asProp) asProp.value = row.assessmentSubmission ?? 0;
        if (scoreProp)  scoreProp.value  = row.score ?? 0;
        if (changeProp) changeProp.value = row.change ?? 0;
      } else if (active === 'attendance') {
        if (laProp) laProp.value = row.attendanceLevel ?? 0;
        if (mcProp) mcProp.value = row.attendanceDay   ?? 0;
        if (hwProp) hwProp.value = 0;
        if (asProp) asProp.value = 0;
        if (scoreProp)  scoreProp.value  = row.score ?? 0;
        if (changeProp) changeProp.value = 0;
      } else if (active === 'homework') {
        if (hwProp) hwProp.value = row.homeworkLevel ?? 0;
        if (asProp) asProp.value = row.homeworkDay   ?? 0;
        if (laProp) laProp.value = 0;
        if (mcProp) mcProp.value = 0;
        if (scoreProp)  scoreProp.value  = row.score ?? 0;
        if (changeProp) changeProp.value = 0;
      }

      const skinPropE = entryVM.number?.('Skin')      ?? entryVM.getNumber?.('Skin');
      const bodyPropE = entryVM.number?.('BodyShape') ?? entryVM.getNumber?.('BodyShape');
      const hairPropE = entryVM.number?.('Hair')      ?? entryVM.getNumber?.('Hair');
      if (skinPropE || bodyPropE || hairPropE) {
        const [dA, dB, dC] = avatarDigits(row.userId);
        if (skinPropE) skinPropE.value = dA;
        if (bodyPropE) bodyPropE.value = dB;
        if (hairPropE) hairPropE.value = dC;
      }
    } else {
      if (posProp)   posProp.value   = fallbackPosition || 0;
      if (nameProp)  nameProp.value  = '';
      if (scoreProp) scoreProp.value = 0;
      if (changeProp) changeProp.value = 0;
      if (laProp) laProp.value = 0;
      if (mcProp) mcProp.value = 0;
      if (hwProp) hwProp.value = 0;
      if (asProp) asProp.value = 0;
    }
  }

  function writeStudent(svm, row) {
    const sName  = svm?.string?.('StudentName')     ?? svm?.getString?.('StudentName');
    const sPos   = svm?.number?.('StudentPosition') ?? svm?.getNumber?.('StudentPosition');
    const sScore = svm?.number?.('StudentScore')    ?? svm?.getNumber?.('StudentScore');
    const sChg   = svm?.number?.('StudentChange')   ?? svm?.getNumber?.('StudentChange');

    if (!row) {
      console.warn('[STUDENT] no row to write');
      if (sName)  sName.value  = '';
      if (sPos)   sPos.value   = 0;
      if (sScore) sScore.value = 0;
      if (sChg)   sChg.value   = 0;
      return;
    }

    console.log('[STUDENT] write', {name: row.name, pos: row.position, uid: row.userId, mode: active});
    if (sName) sName.value = row.name ?? '';
    if (sPos)  sPos.value  = row.position ?? 0;
    if (sScore) sScore.value = row.score ?? 0;
    if (sChg)   sChg.value   = (active === 'points') ? (row.change ?? 0) : 0;

    const sSkinDir = svm?.number?.('Skin')      ?? svm?.getNumber?.('Skin');
    const sBodyDir = svm?.number?.('BodyShape') ?? svm?.getNumber?.('BodyShape');
    const sHairDir = svm?.number?.('Hair')      ?? svm?.getNumber?.('Hair');
    if (sSkinDir || sBodyDir || sHairDir) {
      const [dA, dB, dC] = avatarDigits(row.userId);
      if (sSkinDir) sSkinDir.value = dA;
      if (sBodyDir) sBodyDir.value = dB;
      if (sHairDir) sHairDir.value = dC;
    }
  }

  // ---------- Parsers ----------
  function parsePoints(csvText) {
    const rows = parseCSV(csvText).filter(r => r.length && r.some(c => (c || '').trim() !== ''));
    if (!rows.length) return [];
    const headers = rows[0].map(h => (h || '').trim().toLowerCase());
    const idx = name => headers.indexOf(name);
    const nameI   = idx('name');
    const userI   = idx('userid');
    const scoreI  = idx('score');
    const changeI = idx('change');
    const lessonI = idx('lesson attendance');
    const moduleI = idx('module completion');
    const hwI     = idx('homework');
    const assessI = idx('assessment submission');
    const out = rows.slice(1).map((r,i) => ({
      i,
      userId: String(r[userI] ?? '').trim(),
      name: String(r[nameI] ?? '').trim(),
      score: num(r[scoreI]),
      change: num(r[changeI]),
      lessonAttendance: num(r[lessonI]),
      moduleCompletion: num(r[moduleI]),
      homework: num(r[hwI]),
      assessmentSubmission: num(r[assessI]),
    })).filter(x => x.name);
    console.log('[PARSE:points] rows:', out.length, 'first:', out[0]);
    return out;
  }

  function parseAttendance(csvText) {
    const rows = parseCSV(csvText).filter(r => r.length && r.some(c => (c || '').trim() !== ''));
    if (!rows.length) return [];
    const headers = rows[0].map(h => (h || '').trim().toLowerCase());
    const idx = name => headers.indexOf(name);
    const nameI   = idx('name');
    const userI   = idx('userid');
    const levelI  = idx('attendance level');
    const dayI    = idx('attendance day');
    const scoreI  = idx('score');
    const out = rows.slice(1).map((r,i) => ({
      i,
      userId: String(r[userI] ?? '').trim(),
      name: String(r[nameI] ?? '').trim(),
      attendanceLevel: num(r[levelI]),
      attendanceDay:   num(r[dayI]),
      score: num(scoreI >= 0 ? r[scoreI] : 0),
      change: 0,
    })).filter(x => x.name);
    console.log('[PARSE:attendance] rows:', out.length, 'first:', out[0]);
    return out;
  }

  function parseHomework(csvText) {
    const rows = parseCSV(csvText).filter(r => r.length && r.some(c => (c || '').trim() !== ''));
    if (!rows.length) return [];
    const headers = rows[0].map(h => (h || '').trim().toLowerCase());
    const idx = name => headers.indexOf(name);
    const nameI   = idx('name');
    const userI   = idx('userid');
    const levelI  = idx('homework level');
    const dayI    = idx('homework day');
    const scoreI  = idx('score');
    const out = rows.slice(1).map((r,i) => ({
      i,
      userId: String(r[userI] ?? '').trim(),
      name: String(r[nameI] ?? '').trim(),
      homeworkLevel: num(r[levelI]),
      homeworkDay:   num(r[dayI]),
      score: num(scoreI >= 0 ? r[scoreI] : 0),
      change: 0,
    })).filter(x => x.name);
    console.log('[PARSE:homework] rows:', out.length, 'first:', out[0]);
    return out;
  }

  // ---------- CSV helpers & misc ----------
  function parseCSV(text) {
    const rows = [];
    let row = [], field = "", inQuotes = false;
    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      if (inQuotes) {
        if (c === '"') {
          if (text[i + 1] === '"') { field += '"'; i++; }
          else { inQuotes = false; }
        } else field += c;
      } else {
        if (c === '"') inQuotes = true;
        else if (c === ',') { row.push(field); field = ""; }
        else if (c === '\n') { row.push(field); rows.push(row); row = []; field = ""; }
        else if (c === '\r') { /* ignore */ }
        else field += c;
      }
    }
    row.push(field);
    rows.push(row);
    return rows;
  }

  function num(v) {
    if (v == null) return 0;
    const n = Number(String(v).replace(/[, ]+/g, ''));
    return isNaN(n) ? 0 : n;
  }

  function getCurrentUserId() {
    const u = new URL(location.href);
    return u.searchParams.get('userId') || u.searchParams.get('user') || DEFAULT_USER_ID;
  }

  function avatarDigits(userId) {
    const m = String(userId || '').match(/(\d)(\d)(\d)$/);
    return m ? [Number(m[1]), Number(m[2]), Number(m[3])] : [0, 0, 0];
  }

  function firePlay() {
    const play = vm1?.trigger?.('Play') || vm1?.getTrigger?.('Play');
    if (play?.trigger) play.trigger();
    else if (play?.fire) play.fire();
  }

  function setLoaded(flag) {
    const b = vm1?.boolean?.('isLoaded') ?? vm1?.getBoolean?.('isLoaded');
    if (b && 'value' in b) b.value = !!flag;
  }
</script>
</body>
</html>